{"ast":null,"code":"import _asyncToGenerator from \"@babel/runtime/helpers/asyncToGenerator\";\nimport _toConsumableArray from \"@babel/runtime/helpers/toConsumableArray\";\nimport _slicedToArray from \"@babel/runtime/helpers/slicedToArray\";\nvar __ReactNativeView = require('react-native').View;\nvar __ReactNativeText = require('react-native').Text;\nimport React, { useEffect, useState } from 'react';\nimport View from \"react-native-web/dist/exports/View\";\nimport StyleSheet from \"react-native-web/dist/exports/StyleSheet\";\nimport TouchableOpacity from \"react-native-web/dist/exports/TouchableOpacity\";\nimport { SafeAreaView } from 'react-native-safe-area-context';\nimport { useSelector, useDispatch } from 'react-redux';\nimport { setSong, setIsSongSelected } from \"../features/songs/songSlice\";\nimport { setMoreLoading, setNoMore, setOffset, setError, setLoad } from \"../features/status/statusSlice\";\nimport { SongItem } from \"./SongItem\";\nimport { InputFetch } from \"./InputFetch\";\nimport { Retry } from \"./Retry\";\nimport axios from 'axios';\nimport { Spinner } from 'tamagui';\nimport { Mutex, Semaphore, withTimeout } from 'async-mutex';\nimport { jsx as _jsx } from \"react/jsx-runtime\";\nimport { jsxs as _jsxs } from \"react/jsx-runtime\";\nexport function Search(_ref) {\n  var navigation = _ref.navigation;\n  var _useState = useState(false),\n    _useState2 = _slicedToArray(_useState, 2),\n    loading = _useState2[0],\n    setLoading = _useState2[1];\n  var _useState3 = useState([]),\n    _useState4 = _slicedToArray(_useState3, 2),\n    songs = _useState4[0],\n    setSongs = _useState4[1];\n  var error = useSelector(function (state) {\n    return state.status.error;\n  });\n  var offset = useSelector(function (state) {\n    return state.status.offset;\n  });\n  var moreLoading = useSelector(function (state) {\n    return state.status.moreLoading;\n  });\n  var load = useSelector(function (state) {\n    return state.status.load;\n  });\n  var termSearch = useSelector(function (state) {\n    return state.songs.termSearch;\n  });\n  var dispatch = useDispatch();\n  var url = `https://itunes.apple.com/search?term=${termSearch.replace(/ /g, '+')}&country=AR&media=music&entity=song&attribute=artistTerm&limit=50&offset=${offset}`;\n  var mutex = new Mutex();\n  useEffect(function () {\n    var time = setTimeout(function () {\n      console.log(\"TERMINO DE BUSQUEDA: \" + termSearch);\n      buscarArtista();\n    }, 500);\n    return function () {\n      return clearTimeout(time);\n    };\n  }, [termSearch]);\n  useEffect(function () {\n    dispatch(setLoad(false));\n    buscarArtista();\n  }, [load]);\n  var cargarDatos = function cargarDatos(data) {\n    if (error & offset > 0) {\n      dispatch(setError(false));\n      return;\n    }\n    dispatch(setError(false));\n    if (data.resultCount == 0 && offset > 0) {\n      dispatch(setNoMore(true));\n    } else if (data.resultCount > 0) {\n      dispatch(setOffset(offset + 50));\n      setSongs(function (songs) {\n        return [].concat(_toConsumableArray(songs), _toConsumableArray(data.results));\n      });\n    }\n  };\n  var buscarArtista = function () {\n    var _ref2 = _asyncToGenerator(function* () {\n      if (termSearch && termSearch.length > 1) {\n        if (moreLoading) return;\n        dispatch(setNoMore(false));\n        if (offset > 0) {\n          dispatch(setMoreLoading(true));\n        } else {\n          setLoading(true);\n          console.log('reiniciando canciones');\n          songs.length = 0;\n        }\n        yield axios.get(url, {\n          headers: {\n            'Cache-Control': 'no-cache'\n          }\n        }).then(function (res) {\n          console.log(url);\n          console.log(\"TERMINO BUSCADO: \" + termSearch);\n          cargarDatos(res.data);\n        }).catch(function (error) {\n          console.log(error);\n          dispatch(setError(true));\n        });\n        setLoading(false);\n        dispatch(setMoreLoading(false));\n      }\n    });\n    return function buscarArtista() {\n      return _ref2.apply(this, arguments);\n    };\n  }();\n  return _jsx(SafeAreaView, {\n    style: styles.main,\n    children: _jsxs(View, {\n      style: styles.main,\n      children: [_jsx(InputFetch, {\n        navigation: navigation\n      }), loading ? _jsx(Spinner, {\n        style: styles.centerText,\n        size: \"large\"\n      }) : _jsxs(View, {\n        style: styles.main,\n        children: [_jsx(Retry, {}), _jsx(SongItem, {\n          songs: songs\n        })]\n      })]\n    })\n  });\n}\nexport default Search;\nvar styles = StyleSheet.create({\n  main: {\n    flex: 1,\n    flexGrow: 1,\n    flexDirection: 'column'\n  },\n  loading: {\n    position: 'absolute',\n    left: 0,\n    right: 0,\n    top: 0,\n    bottom: 0,\n    alignItems: 'center',\n    justifyContent: 'center'\n  },\n  centerText: {\n    flex: 1,\n    alignItems: 'center',\n    justifyContent: 'center'\n  },\n  alertText: {\n    width: '85%',\n    fontSize: 20,\n    textAlign: 'center'\n  },\n  footerText: {\n    flex: 1,\n    alignItems: 'center',\n    justifyContent: 'center',\n    marginVertical: 10\n  }\n});","map":{"version":3,"names":["React","useEffect","useState","View","StyleSheet","TouchableOpacity","SafeAreaView","useSelector","useDispatch","setSong","setIsSongSelected","setMoreLoading","setNoMore","setOffset","setError","setLoad","SongItem","InputFetch","Retry","axios","Spinner","Mutex","Semaphore","withTimeout","jsx","_jsx","jsxs","_jsxs","Search","_ref","navigation","_useState","_useState2","_slicedToArray","loading","setLoading","_useState3","_useState4","songs","setSongs","error","state","status","offset","moreLoading","load","termSearch","dispatch","url","replace","mutex","time","setTimeout","console","log","buscarArtista","clearTimeout","cargarDatos","data","resultCount","concat","_toConsumableArray","results","_ref2","_asyncToGenerator","length","get","headers","then","res","catch","apply","arguments","style","styles","main","children","centerText","size","create","flex","flexGrow","flexDirection","position","left","right","top","bottom","alignItems","justifyContent","alertText","width","fontSize","textAlign","footerText","marginVertical"],"sources":["/Users/juanfer14/Public/itunes-edamm/components/Search.jsx"],"sourcesContent":["import React, { useEffect, useState } from 'react'\nimport { View, StyleSheet,  TouchableOpacity} from 'react-native';\n\n// Importo SafeAreaView para considerar los margenes del status-bar\nimport { SafeAreaView } from 'react-native-safe-area-context';\n\n// Importo metodos del store y slices\nimport { useSelector, useDispatch } from 'react-redux';\nimport { setSong, setIsSongSelected } from '../features/songs/songSlice';\nimport { setMoreLoading, setNoMore, setOffset, setError, setLoad } from '../features/status/statusSlice'\n\nimport { SongItem } from './SongItem'\nimport { InputFetch } from './InputFetch'\nimport { Retry } from './Retry'\n\n\n// Importo axios para fetching\nimport axios from 'axios'\n\n// Importo componente de librerias\nimport { Spinner } from 'tamagui'\n\n// Importo mutex para sincronismo\nimport {Mutex, Semaphore, withTimeout} from 'async-mutex';\n\n\n\n\nexport function Search({ navigation }) {\n    // States\n    const [loading, setLoading] = useState(false);\n    const [songs, setSongs] = useState([]);\n\n    // Stores\n    const error = useSelector(state => state.status.error);\n    const offset = useSelector(state => state.status.offset);\n    const moreLoading = useSelector(state => state.status.moreLoading);\n    const load = useSelector(state => state.status.load)\n    // Termino a buscar\n    const termSearch = useSelector(state => state.songs.termSearch)\n\n\n    \n    // Dispatcher para ejecutar acciones de las stores\n    const dispatch = useDispatch();\n\n    // La API de itunes necesita que los espacios se reemplazen por '+'\n    // https://stackoverflow.com/questions/3794919/replace-all-spaces-in-a-string-with\n    // URL donde se debe realizar la consulta\n    const url = `https://itunes.apple.com/search?term=${termSearch.replace(/ /g, '+')}&country=AR&media=music&entity=song&attribute=artistTerm&limit=50&offset=${offset}`\n    \n\n    const mutex = new Mutex();\n\n    useEffect( () => {\n        const time = setTimeout(() => {\n            console.log(\"TERMINO DE BUSQUEDA: \" + termSearch)\n            buscarArtista();\n        }, 500)\n        \n        return () => clearTimeout(time);\n        \n    }, [termSearch]);\n\n\n    useEffect(() => {\n        dispatch(setLoad(false))\n        buscarArtista();\n    }, [load])\n\n      \n    \n    const cargarDatos = (data) => {\n        // Si proviene de un error y ya cargo datos, no cargo mas datos\n        if(error & offset > 0) {\n            dispatch(setError(false));     \n            return;\n        }\n        // Si proviene de un error y no cargo datos, entonces si carga\n        dispatch(setError(false));\n\n        // Verificar la cantidad de resultados que se retornan\n        if(data.resultCount == 0 && offset > 0){\n            dispatch(setNoMore(true))\n        }\n        else if(data.resultCount > 0){\n            dispatch(setOffset(offset + 50))\n            setSongs(songs => [...songs, ...data.results]) \n        }       \n    }\n\n    const buscarArtista = async() => {\n        if(termSearch && termSearch.length > 1){\n            if(moreLoading) return;\n            \n            dispatch(setNoMore(false));\n        \n            if(offset > 0){\n              dispatch(setMoreLoading(true))\n            }\n            else{\n                setLoading(true);\n                console.log('reiniciando canciones')\n                songs.length = 0;\n            }\n\n            \n            await axios.get(url, { headers: { 'Cache-Control': 'no-cache' } })\n                    .then(res => {\n                        console.log(url)\n                        console.log(\"TERMINO BUSCADO: \" + termSearch)\n                        cargarDatos(res.data)\n                    })\n                    .catch(error => {\n                        console.log(error);\n                        dispatch(setError(true));\n                    })\n             \n            \n            setLoading(false);\n            dispatch(setMoreLoading(false));\n            \n            \n        }\n        \n        \n    };\n\n    return ( \n        <SafeAreaView style={styles.main}>\n            <View style={styles.main}>\n                <InputFetch navigation={navigation}/>\n                { \n                    loading ?\n                        <Spinner style={styles.centerText} size=\"large\" />        \n                    : \n                        <View style={styles.main} >\n                            <Retry/>\n                            <SongItem songs={songs}/>\n                        </View>\n                }\n            </View>\n        </SafeAreaView>\n    )\n}\n\nexport default Search;\n\nconst styles = StyleSheet.create({\n    main: {\n        flex: 1,\n        flexGrow: 1,\n        flexDirection: 'column'\n    },\n    loading: {\n        position: 'absolute',\n        left: 0,\n        right: 0,\n        top: 0,\n        bottom: 0,\n        alignItems: 'center',\n        justifyContent: 'center',\n    },\n    centerText: {\n        flex: 1,\n        alignItems: 'center',\n        justifyContent: 'center'\n    },\n    alertText: {\n        width: '85%',\n        fontSize: 20,\n        textAlign: 'center',\n    },\n    footerText: {\n        flex: 1, \n        alignItems: 'center',\n        justifyContent: 'center',\n        marginVertical: 10\n    },\n});"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}